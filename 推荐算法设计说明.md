# 商家管理后台推荐算法设计说明（多维度融合协同过滤）

## 系统设置：推荐算法权重配置

后台可配置两类权重：

1. **模型融合权重**（最终结果）
   - `cf_weight`, `ctr_weight`, `cvr_weight`
2. **协同过滤内部四维权重**（CF 相似度）
   - `w1=attr_weight` 个人属性
   - `w2=consume_weight` 消费行为
   - `w3=rating_weight` 评分反馈
   - `w4=dish_weight` 菜品偏好

默认四维权重：

- `w1 = 0.2`
- `w2 = 0.3`
- `w3 = 0.3`
- `w4 = 0.2`

---

## 1. 数据预处理模块

技术实现：**Pandas** 数据清洗与特征工程（`recommend-engine-python/data/extract.py`）

输入表：

- `reco_event_log`（曝光/点击/收藏/下单/支付）
- `user_collect`
- `user_order`, `user_order_detail`
- `reco_user_profile_daily`
- `sys_goods`

关键处理：

- 缺失值填充、去重、类型转换
- 用户画像标签化（新用户/中活跃/高活跃，高价值标签）
- 行为矩阵构建（用户-商品消费向量、评分向量）
- 菜品偏好集合构建（常购分类集合）
- 时间衰减（近期行为权重更高）

---

## 2. 相似度计算模块

总体相似度公式：

`Sim(Ui, Uj) = w1×SimAttr + w2×SimConsume + w3×SimRating + w4×SimDish`

四个维度实现如下：

- `个人属性相似度`：Jaccard 系数  
  `len(set_a & set_b) / len(set_a | set_b)`
- `消费行为相似度`：余弦相似度（NumPy）  
  `np.dot(a, b) / (np.linalg.norm(a) * np.linalg.norm(b))`
- `评分反馈相似度`：皮尔逊相关系数（NumPy）  
  `np.corrcoef(ratings_a, ratings_b)[0, 1]`
- `菜品偏好相似度`：Jaccard 系数（常购菜品分类集合）

实现文件：`recommend-engine-python/models/cf.py`

核心函数：

- `train_user_similarity_multidim(feature_pack, dim_weights)`
- `score_candidates_topk_multidim(openid, user_sim, user_items, all_goods, k=10)`

---

## 3. 时间衰减模块

目标：强化近期行为影响，弱化历史行为影响。

当前实现：

- 在事件转隐式反馈时使用指数衰减：  
  `decay = exp(-0.03 * delta_days)`
- 最终反馈分 = `事件基础权重 × decay`

事件基础权重示例：

- `expose=0.2, click=1.0, collect=2.5, order=3.0, pay=3.5`

---

## 4. 推荐生成模块

推荐流程（当前实现）：

1. 使用 NumPy 批量计算用户相似度矩阵
2. 选取相似度最高 K 个用户（`K=10`）
3. 汇总相似用户喜欢但目标用户未购买的菜品
4. 按加权评分排序，输出 Top-N 推荐

离线输出：

- `reco_result`（CF/CTR/CVR 分模型结果）
- `reco_blend_result`（融合结果）
- `reco_job`（训练任务记录）

在线输出接口：

- `GET /wxapi/reco/list`

---

## 5. 在线推理与融合

在线请求链路（Java）：

1. 根据规则与画像确定融合权重
2. 优先 JNI 在线推理（Python）
3. JNI 不可用则按 `reco_result` 实时重融
4. 再回退到 `reco_blend_result`
5. 最后兜底热推

融合公式：

`FinalScore = cf_weight×CF + ctr_weight×CTR + cvr_weight×CVR`

---

## 6. 输入 / 算法函数 / 输出总结

### 输入

- 用户、商品、行为、画像、配置权重

### 算法函数

- `build_cf_feature_pack`（Pandas 特征工程）
- `train_user_similarity_multidim`（四维相似度融合）
- `score_candidates_topk_multidim`（TopK 邻域推荐）
- `build_ctr_scores` / `build_cvr_scores`

### 输出

- 数据库：`reco_result`, `reco_blend_result`, `reco_job`
- 接口：`/wxapi/reco/list` 推荐结果（含 `score`、`rankNo`）
